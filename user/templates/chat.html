<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <style>
        #chat { border: 1px solid #ddd; height: 400px; overflow-y: auto; padding: 5px; }
        .msg.me { text-align: right; color: green; }
        .msg.other { text-align: left; color: blue; }
    </style>
</head>
<body>

<h2>Chat</h2>

<h3>
    {% if user.is_authenticated %}
    {% if user.is_superuser %}
    <p>Hello, Admin!</p>
    {% else %}
    <p>Hello, {{ user.username }}!</p>
    {% endif %}
    {% else %}
    <p>Welcome, guest!</p>
    {% endif %}
</h3>

<div id="chat"></div>

<input id="msg" placeholder="Xabar yozing...">
<button onclick="sendMsg()">Yuborish</button>

<script>
    const chatBox = document.getElementById("chat");

    // SUPERUSER NI FRONTENDDA ADMIN DEB OLAMIZ
    const currentUser =
        "{{ request.user.is_superuser }}" === "True"
            ? "Admin"
            : "{{ request.user.username }}";

    function addMessageToChat(username, message) {
        const div = document.createElement("div");
        div.textContent = `${username}: ${message}`;
        div.className = username === currentUser ? "msg me" : "msg other";
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ----------------------------
    // 1) Eski xabarlarni yuklash
    // ----------------------------
    fetch("/users/api/messages/")
        .then(res => res.json())
        .then(data => {
            chatBox.innerHTML = ""; // chatni tozalaydi

            data.messages.forEach(m => {
                // Backenddan kelgan superuserni ham Adminga aylantiramiz
                const sender = m.is_superuser ? "Admin" : m.username;
                addMessageToChat(sender, m.text);
            });
        });

    // ----------------------------
    // 2) WebSocket
    // ----------------------------
    const socket = new WebSocket("ws://127.0.0.1:8000/ws/chatty/");

    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        // Superuserni Adminga aylantirish
        const sender = data.is_superuser ? "Admin" : data.username;

        addMessageToChat(sender, data.message);
    };

    function sendMsg() {
        const input = document.getElementById("msg");
        if (!input.value.trim()) return;

        socket.send(JSON.stringify({
            message: input.value
        }));

        input.value = "";
    }
</script>

</body>
</html>
